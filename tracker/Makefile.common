# Common makefile settings and source files

# Common source directories
COMMON_LIBS = src ../chipnomad_lib ../chipnomad_lib/chips ../chipnomad_lib/external/ayumi ../chipnomad_lib/export ../chipnomad_lib/corelib_file_stdio src/corelib src/import src/screens platforms/shared

# Base build directory
BUILD_BASE = build

# Platform-specific build directory (to be set by platform makefiles)
BUILD = $(BUILD_BASE)/$(PLATFORM)

# Common includes and sources
INCLUDES = $(addprefix -I, $(LIBS)) -I../chipnomad_lib
SOURCES = $(foreach dir, $(LIBS), $(wildcard $(dir)/*.c))
SRC_FILES = $(foreach dir, $(LIBS), $(wildcard $(dir)/*.c)) $(foreach dir, $(LIBS), $(wildcard $(dir)/*.h))

# Common compiler flags
COMMON_CFLAGS = -std=c99 -Wall -g -Os -flto

# Build target helper
define build_target
	mkdir -p $(BUILD)
	$(CC) $(CFLAGS) $(XTRA_LIBS) $(OUTPUT)
	chmod +x $(BUILD)/chipnomad$(OUTPUT_EXT)
endef